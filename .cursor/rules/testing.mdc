---
alwaysApply: true
---
- Write all tests in English.
- Use Pest v4 for all testing (unit, feature, and integration).
- Always run tests with `--parallel` option for faster execution: `composer test` (alias `pest --parallel`).
- After completing a feature or bug fix, write or update tests to cover all affected code.
- Avoid redundant tests: if a feature is already tested, do not add duplicate tests unless its behavior changes in another context.
- A good test is isolated, deterministic, and fast — it should not depend on external services or shared state.
- Use factories and database transactions (RefreshDatabase) to ensure clean test data.
- Group related tests using test suites or datasets for clarity and maintainability.
- Two types of tests:
  - Feature (Blade rendering): default values, variants, expected errors.
  - Browser (interactions): critical JS components; no console errors.
- Browser tests: `tests/Browser/` for critical JS interactions.
- Rendering tests: use a helper to normalize HTML generated by Blade components to reduce assertion fragility.
- Target: ≥80% coverage on critical components.

## JavaScript Testing with Vitest

- Use Vitest v4 for all JavaScript unit and DOM tests.
- JavaScript tests are located in `tests/js/` and complement Browser Pest tests.
- Run JavaScript tests with `npm run test:js` (or `npm run test:js:watch` for development).
- Structure:
  - `tests/js/unit/`: Pure unit tests without DOM (environment: `node`)
  - `tests/js/dom/`: Tests requiring DOM interactions (environment: `happy-dom`)
- Test pure functions and utilities in unit tests (e.g., `normalizeText`, `debounce`, `scheduler`).
- Test DOM interactions and module initialization in DOM tests (e.g., `copyable`, `menu-filter`, `kit-init`).
- Mock browser APIs when testing in node environment (`window`, `document`, `localStorage`, `IntersectionObserver`, etc.).
- Use `vi.useFakeTimers()` for time-dependent tests (debounce, throttle, delays).
- Complex modules with external dependencies (Chart.js, Leaflet) are tested via Browser Pest tests, not Vitest.
- Write tests in English, following Vitest conventions (`describe`, `it`, `expect`).
- Keep tests isolated: each test should be independent and not rely on shared state.
- Use `beforeEach` and `afterEach` to set up and clean up test fixtures.
- Target: ≥80% coverage on critical JavaScript modules.
